<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Çekiliş Formu</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{ --bg:#0b1020; --glass:#0f1733cc; --text:#ecf1ff; --muted:#a9b4d6; --primary:#5ea1ff; --accent:#34d399; --danger:#ff6b6b; --ring:0 0 0 3px color-mix(in oklab, var(--primary) 35%, transparent); --border:1px solid rgba(255,255,255,.12); --radius:16px; --shadow:0 16px 40px rgba(0,0,0,.35), 0 4px 14px rgba(0,0,0,.25); }
  @media (prefers-color-scheme: light){ :root{ --text:#0b1020; --muted:#4b5563; --glass:#ffffffd9; --bg:#eef3ff; --border:1px solid rgba(0,0,0,.08); --shadow:0 18px 36px rgba(2,6,23,.08), 0 2px 10px rgba(2,6,23,.06);} }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; color:var(--text); font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#000 url('https://images.wallpapersden.com/image/download/world-of-warships-gaming-2023_bW5namiUmZqaraWkpJRmbmdlrWZlbWU.jpg') center/cover fixed no-repeat; }
  .overlay{position:fixed; inset:0; background: radial-gradient(1000px 600px at 20% 10%, rgba(0,0,0,.45), transparent 60%), linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55)); pointer-events:none;}
  .container{max-width:980px; margin:min(6vh,64px) auto; padding:20px}
  .card{background:var(--glass); border:var(--border); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px) saturate(120%); overflow:hidden}
  .header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:18px 20px; border-bottom:var(--border); flex-wrap:wrap}
  .title{margin:0; font-size:clamp(22px,3vw,32px)}
  .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .support{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:14px; border:var(--border); background:color-mix(in oklab, var(--glass) 96%, transparent); font-weight:700}
  .support i{width:8px;height:8px;border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent)}
  .lang{display:flex; gap:8px}
  .lang button{border:var(--border); background:var(--glass); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer}
  .lang button[aria-pressed="true"]{box-shadow:var(--ring)}
  form{display:grid; gap:16px; padding:18px}
  .grid{display:grid; gap:12px}
  @media (min-width:720px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
  .field{position:relative}
  .field input,.field select,.field textarea{ width:100%; padding:16px 14px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background:color-mix(in oklab, var(--glass) 92%, transparent); color:var(--text); outline:none; min-height:48px }
  .field input::placeholder{color:transparent}
  .field label{ position:absolute; left:12px; top:10px; padding:0 6px; pointer-events:none; color:var(--muted); background:var(--glass); transform-origin:left top; transition:.15s }
  .field input:focus,.field select:focus,.field textarea:focus{ box-shadow:var(--ring); border-color:color-mix(in oklab, var(--primary) 40%, transparent) }
  .field input:not(:placeholder-shown)+label, .field input:focus+label, .field textarea:not(:placeholder-shown)+label, .field textarea:focus+label{ transform:translateY(-14px) scale(.9); color:color-mix(in oklab, var(--primary) 70%, var(--muted)); }
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  .hint{font-size:.95rem; color:var(--muted)}
  .btn{border:var(--border); background:linear-gradient(180deg, color-mix(in oklab, var(--primary) 18%, var(--glass)) 0%, var(--glass) 80%); color:var(--text); padding:12px 16px; border-radius:12px; cursor:pointer; box-shadow:var(--shadow); min-height:44px}
  .btn.ghost{background:transparent}
  .dropzone{ border:2px dashed color-mix(in oklab, var(--primary) 35%, transparent); border-radius:12px; padding:20px; text-align:center; background:color-mix(in oklab, var(--glass) 90%, transparent) }
  .dropzone.drag{background:color-mix(in oklab, var(--primary) 10%, transparent)}
  .preview{display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); margin-top:10px}
  .preview img{width:100%; aspect-ratio:1.3/1; object-fit:cover; border-radius:10px; border:var(--border)}
  .counts{display:flex; gap:12px; align-items:center; color:var(--muted); font-weight:600}
  .dot{width:6px;height:6px;border-radius:50%; background:color-mix(in oklab, var(--primary) 60%, white); box-shadow:0 0 8px var(--primary)}
  .notice{ display:flex; gap:10px; align-items:flex-start; background:color-mix(in oklab, var(--danger) 14%, var(--glass)); border:1px solid color-mix(in oklab, var(--danger) 28%, transparent); padding:10px 12px; border-radius:12px }
  .notice i{width:12px;height:12px;border-radius:50%; background:var(--danger); box-shadow:0 0 10px var(--danger); margin-top:4px}
  .toast{position:fixed; right:16px; bottom:16px; background:var(--glass); border:var(--border); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); opacity:0; transform:translateY(10px); transition:.2s}
  .toast.show{opacity:1; transform:none}
  .hidden{display:none !important;}
</style>
</head>
<body>
<div class="overlay" aria-hidden="true"></div>

<div class="container">
  <!-- 404 kartı -->
  <div id="card404" class="card hidden">
    <div class="header"><h1 class="title">404 — Çekiliş Bulunamadı</h1></div>
    <div style="padding:18px">
      <p>Bu <b>rid</b> için çekiliş yok veya kaldırılmış.</p>
      <p class="hint">Örn: <code>?rid=mw-august</code></p>
      <a class="btn" href="./">Ana sayfa</a>
    </div>
  </div>

  <!-- FORM -->
  <div id="cardForm" class="card hidden">
    <div class="header">
      <h1 class="title" id="pageTitle">Çekiliş Formu</h1>
      <div class="right">
        <div class="support"><i></i><span id="dateInfo" class="hint">—</span></div>
        <div class="lang" role="group" aria-label="Dil">
          <button type="button" id="trBtn" aria-pressed="true">TR</button>
          <button type="button" id="enBtn" aria-pressed="false">EN</button>
        </div>
      </div>
    </div>

    <form id="gameForm" novalidate>
      <input type="text" id="website" class="hidden" autocomplete="off" tabindex="-1" aria-hidden="true"/>
      <input type="hidden" id="rid" name="rid" value="">

      <div class="grid cols-2">
        <div class="field"><input id="gameName" name="gameName" placeholder=" " required maxlength="60"/><label for="gameName" data-i="gameNameLabel">Oyuncu Adı *</label><p class="hint" data-i="gameNameHint">Örn: Velour</p></div>
        <div class="field"><input id="gameId" name="gameId" placeholder=" " required maxlength="40"/><label for="gameId" data-i="gameIdLabel">Oyuncu Kimliği *</label><p class="hint" data-i="gameIdHint">Oyundaki benzersiz kimliğin</p></div>
        <div class="field"><input id="discord" name="discord" placeholder=" " required maxlength="50"/><label for="discord" data-i="discordLabel">Discord Kullanıcı Adı *</label><p class="hint" data-i="discordHint">Örn: Captain#1234 veya @kullanıcı</p></div>
        <div class="field"><input id="email" name="email" type="email" placeholder=" " required maxlength="120"/><label for="email" data-i="emailLabel">E-posta *</label><p class="hint" data-i="emailHint">Kod bu e-postaya gelir</p></div>
        <div class="field">
          <select id="subscriber" name="subscriber" required>
            <option value="" selected disabled hidden></option><option>Evet</option><option>Hayır</option>
          </select>
          <label for="subscriber" data-i="subscriberLabel">YouTube’a abone misin? *</label>
          <p class="hint">YouTube: <a id="ytChannel" href="https://www.youtube.com/@mwharp" target="_blank" rel="noopener noreferrer">@mwharp</a></p>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="row"><strong data-i="uploadTitle">Kanıt / Görsel Yükleme</strong><span class="hint" data-i="uploadHint">max 6 dosya | tekil ≤ 8 MB | toplam ≤ 9 MB</span></div>
          <div id="dropzone" class="dropzone" aria-label="Dosya yükleme alanı">
            <p><b data-i="dropText1">Dosyayı sürükleyip bırak</b> <span data-i="dropText2">veya tıkla.</span></p>
            <input id="fileInput" type="file" class="hidden" multiple accept="image/*,.pdf"/>
            <button class="btn ghost" type="button" id="fileBrowse" data-i="chooseFile">Dosya Seç</button>
            <div id="preview" class="preview"></div>
          </div>
          <div class="row" style="margin-top:8px"><div class="counts"><span class="dot"></span><span id="fileCount">0 / 6</span><span>•</span><span id="fileSize">0 MB / 9 MB</span></div></div>
        </div>
        <div class="notice"><i aria-hidden="true"></i><div data-i="alert">⚠ Abone olmayanların formları dikkate alınmayacaktır.</div></div>
      </div>

      <div class="row" style="padding:14px 18px; border-top:1px solid rgba(255,255,255,.12)">
        <div id="formErrors" class="hint" aria-live="polite"></div>
        <div class="row"><button class="btn ghost" type="reset" id="resetBtn" data-i="reset">Sıfırla</button><button class="btn" id="sendBtn" type="submit" data-i="send">Gönder</button></div>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== Worker URL ===== */
const WORKER_BASE = "https://spring-dream-b90b.velour662.workers.dev";
const ENDPOINT = WORKER_BASE + "/submit";

/* ===== rid + meta ===== */
const params = new URLSearchParams(location.search);
const currentRid = (params.get("rid")||"").trim().toLowerCase();
document.getElementById("rid").value = currentRid;

async function loadMetaOr404(){
  if(!currentRid){ show404(); return; }
  try{
    const r = await fetch(WORKER_BASE+"/meta?rid="+encodeURIComponent(currentRid), { mode:"cors" });
    if(!r.ok){ show404(); return; }
    const j = await r.json(); const m = j.meta||{};
    document.getElementById("pageTitle").textContent = m.title || "Çekiliş";
    document.title = m.title ? (m.title+" • Çekiliş") : "Çekiliş";
    const s = m.startAt ? new Date(m.startAt).toLocaleString("tr-TR") : "—";
    const e = m.endAt   ? new Date(m.endAt).toLocaleString("tr-TR")   : "—";
    document.getElementById("dateInfo").textContent = s+" → "+e+(m.closed?" • Kapalı":"");
    const yt = document.getElementById("ytChannel"); yt.href = m.youtubeLink||yt.href; yt.textContent = m.youtubeHandle||yt.textContent;
    document.getElementById("card404").classList.add("hidden");
    document.getElementById("cardForm").classList.remove("hidden");
  }catch{ show404(); }
}
function show404(){ document.getElementById("cardForm").classList.add("hidden"); document.getElementById("card404").classList.remove("hidden"); }

/* ===== i18n (kısa) ===== */
const tr={ gameNameLabel:"Oyuncu Adı *",gameNameHint:"Örn: Velour",gameIdLabel:"Oyuncu Kimliği *",gameIdHint:"Oyundaki benzersiz kimliğin",discordLabel:"Discord Kullanıcı Adı *",discordHint:"Örn: Captain#1234 veya @kullanıcı",emailLabel:"E-posta *",emailHint:"Kod bu adrese gönderilir",subscriberLabel:"YouTube’a abone misin? *",uploadTitle:"Kanıt / Görsel Yükleme",uploadHint:"YouTube abonelik ekran görüntüsü vb.",dropText1:"Dosyayı sürükleyip bırak",dropText2:"veya tıkla.",chooseFile:"Dosya Seç",alert:"⚠ Abone olmayanların formları dikkate alınmayacaktır.",reset:"Sıfırla",send:"Gönder",err_required:"Lütfen zorunlu alanları doldurun.",toast_reset:"Form sıfırlandı.",toast_sent:"Gönderildi! Teşekkürler.",toast_fail_prefix:"Gönderim başarısız: " };
const en={ gameNameLabel:"Player Name *",gameNameHint:"e.g., Velour",gameIdLabel:"Player ID *",gameIdHint:"Your unique in-game identifier",discordLabel:"Discord Username *",discordHint:"e.g., Captain#1234 or @user",emailLabel:"Email *",emailHint:"Code will be sent here",subscriberLabel:"Are you subscribed on YouTube? *",uploadTitle:"Proof / Image Upload",uploadHint:"YouTube subscription screenshot etc.",dropText1:"Drag & drop files",dropText2:"or click.",chooseFile:"Choose File",alert:"⚠ Non-subscribed entries are ignored.",reset:"Reset",send:"Submit",err_required:"Please fill the required fields.",toast_reset:"Form reset.",toast_sent:"Sent! Thank you.",toast_fail_prefix:"Submit failed: " };
let dict=tr; function tSet(sel,key){const el=document.querySelector(sel); if(el) el.innerHTML=dict[key];}
function applyI18n(){ tSet('[for="gameName"]','gameNameLabel');tSet('[data-i="gameNameHint"]','gameNameHint');tSet('[for="gameId"]','gameIdLabel');tSet('[data-i="gameIdHint"]','gameIdHint');tSet('[for="discord"]','discordLabel');tSet('[data-i="discordHint"]','discordHint');tSet('[for="email"]','emailLabel');tSet('[data-i="emailHint"]','emailHint');tSet('[for="subscriber"]','subscriberLabel');tSet('[data-i="uploadTitle"]','uploadTitle');tSet('[data-i="uploadHint"]','uploadHint');tSet('[data-i="dropText1"]','dropText1');tSet('[data-i="dropText2"]','dropText2');tSet('[data-i="chooseFile"]','chooseFile');tSet('[data-i="alert"]','alert');tSet('[data-i="reset"]','reset');tSet('[data-i="send"]','send'); }
document.getElementById('trBtn').onclick=function(){dict=tr;this.setAttribute('aria-pressed','true');document.getElementById('enBtn').setAttribute('aria-pressed','false');applyI18n();}
document.getElementById('enBtn').onclick=function(){dict=en;this.setAttribute('aria-pressed','true');document.getElementById('trBtn').setAttribute('aria-pressed','false');applyI18n();}
applyI18n();

/* ===== helpers ===== */
const $=s=>document.querySelector(s);
function toast(msg,ms=2500){const t=$("#toast");t.textContent=typeof msg==="string"?msg:JSON.stringify(msg);t.classList.add("show");clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove("show"),ms);}

/* ===== dropzone ===== */
const MAX_FILES=6, MAX_FILE_SIZE=8*1024*1024, MAX_TOTAL_SIZE=9*1024*1024;
const ALLOWED_TYPES=["image/jpeg","image/png","image/webp","image/gif","image/heic","image/heif","application/pdf"];
const drop=$("#dropzone"), finput=$("#fileInput"), browse=$("#fileBrowse"), preview=$("#preview");
const fileCountEl=$("#fileCount"), fileSizeEl=$("#fileSize");
browse.onclick=()=>finput.click();
["dragenter","dragover"].forEach(evn=> drop.addEventListener(evn,e=>{e.preventDefault();drop.classList.add("drag");}));
["dragleave","drop"].forEach(evn=> drop.addEventListener(evn,e=>{e.preventDefault();drop.classList.remove("drag");}));
drop.addEventListener("drop",e=> handleFiles(e.dataTransfer.files));
finput.addEventListener("change",()=> handleFiles(finput.files));
let filesState=[]; function bytesToMB(n){return Math.round(n/1024/1024);}
function refreshCounters(){const total=filesState.reduce((a,f)=>a+f.size,0); fileCountEl.textContent=`${filesState.length} / ${MAX_FILES}`; fileSizeEl.textContent=`${bytesToMB(total)} MB / 9 MB`; }
function handleFiles(list){const arr=[...list]; let picked=arr.slice(0,MAX_FILES); let total=0; const valid=[]; for(const f of picked){ if(!ALLOWED_TYPES.includes(f.type)){toast(`${f.name}: desteklenmiyor`); continue;} if(f.size>MAX_FILE_SIZE){toast(`${f.name}: çok büyük`); continue;} if(total+f.size>MAX_TOTAL_SIZE){toast(`Toplam sınır aşıldı`); break;} total+=f.size; valid.push(f);} filesState=valid; preview.innerHTML=""; filesState.forEach(file=>{const card=document.createElement("div"); if(file.type.startsWith("image/")){const img=document.createElement("img"); img.alt=file.name; card.appendChild(img); const reader=new FileReader(); reader.onload=ev=> img.src=ev.target.result; reader.readAsDataURL(file);} else {card.innerHTML=`<div class="hint" style="border:var(--border);border-radius:10px;padding:8px">${file.name}</div>`;} preview.appendChild(card);}); if(arr.length>MAX_FILES) toast(`En fazla ${MAX_FILES} dosya`); refreshCounters(); } refreshCounters();

/* ===== form ===== */
function validate(){ if($("#website").value){ return false; } let ok=true; $("#formErrors").textContent=""; ["#gameName","#gameId","#discord","#email","#subscriber"].forEach(sel=>{const el=$(sel); el.classList.remove("error"); if(!el.value || (el.tagName==="SELECT" && el.value==="")){ el.classList.add("error"); ok=false; }}); if(!ok){ $("#formErrors").innerHTML=`<span class="hint" style="color:#ff6b6b">${dict.err_required}</span>`; } return ok; }
async function sendToWorker(signal){
  if(!currentRid) throw new Error("RID yok.");
  // meta ile var mı kontrol
  const chk = await fetch(WORKER_BASE+"/meta?rid="+encodeURIComponent(currentRid), { mode:"cors", signal });
  if (chk.status===404) throw new Error("Bu rid için çekiliş yok.");
  const fd=new FormData();
  fd.append("rid", currentRid);
  fd.append("gameName", $("#gameName").value.trim());
  fd.append("gameId", $("#gameId").value.trim());
  fd.append("discord", $("#discord").value.trim());
  fd.append("email", $("#email").value.trim());
  fd.append("subscriber", $("#subscriber").value);
  filesState.forEach(f=> fd.append("attachments", f, f.name));
  const res = await fetch(ENDPOINT+"?rid="+encodeURIComponent(currentRid), { method:"POST", body:fd, signal, mode:"cors" });
  const text = await res.text(); let json={}; try{ json=JSON.parse(text);}catch{ json={ ok:false, error:text||"Beklenmeyen cevap" }; }
  if(!res.ok || !json.ok) throw new Error(json.error || ("HTTP "+res.status));
  return true;
}
const form=$("#gameForm"), sendBtn=$("#sendBtn");
form.addEventListener("submit", async (e)=>{
  e.preventDefault(); if(!validate()) return;
  const c=new AbortController(); const t=setTimeout(()=>c.abort(), 30000);
  sendBtn.disabled=true; sendBtn.classList.add("loading");
  try{ await sendToWorker(c.signal); toast(dict.toast_sent); form.reset(); filesState=[]; $("#preview").innerHTML=""; refreshCounters(); }
  catch(err){ console.error(err); toast((dict.toast_fail_prefix||"")+ (err.message||"Bilinmeyen hata"),4000); }
  finally{ clearTimeout(t); sendBtn.disabled=false; sendBtn.classList.remove("loading"); }
});
document.getElementById("resetBtn").onclick=function(){ filesState=[]; $("#preview").innerHTML=""; refreshCounters(); toast(dict.toast_reset); };

/* init */
loadMetaOr404();
</script>
</body>
</html>
