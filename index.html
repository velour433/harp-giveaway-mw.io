export default {
  async fetch(request, env) {
    try {
      const url  = new URL(request.url);
      const m    = request.method;
      const p    = url.pathname;

      if (m === "OPTIONS") return resCors("");

      if (m === "GET" && p === "/") {
        return resJson({ ok:true, msg:"Worker up" });
      }

      /* ---------- PUBLIC ---------- */

      // GET /meta?rid=...
      if (m === "GET" && p === "/meta") {
        const rid = ridParam(url);
        if (!rid) return resJson({ ok:false, error:"rid gerekli" }, 400);
        const settings = await getSettings(env, rid);
        if (!settings) return resJson({ ok:false, error:"not found" }, 404);
        return resJson({ ok:true, meta: settingsPublic(settings) });
      }

      // POST /submit?rid=...
      if (m === "POST" && p === "/submit") {
        return handleSubmit(request, env);
      }

      // İsteğe bağlı: kod kontrolü (rid'li)
      if (m === "GET" && p === "/check") {
        const rid = ridParam(url);
        const code = str(url.searchParams.get("code"));
        if (!rid || !code) return resJson({ ok:false, error:"rid/kod gerekli" }, 400);
        const codeHash = await sha256hex(code);
        const rec = await env.RAFFLE.get(keyCode(rid, codeHash), { type:"json" });
        const s = await getSettings(env, rid);
        if (!s || !rec) return resJson({ ok:false, status:"not_found" }, 404);
        const now = Date.now();
        const beforeStart = s.startAt && now < s.startAt;
        const afterEnd    = s.endAt && now >= s.endAt;
        const closed      = !!s.closed;
        return resJson({ ok:true, status:"found", raffle:{ beforeStart, afterEnd, closed, startAt:s.startAt||null, endAt:s.endAt||null }, result:{ joinedAt:rec.createdAt, winner:!!rec.winner } });
      }

      /* ---------- ADMIN (auth) ---------- */
      if (p.startsWith("/admin/")) {
        if (!(await authAdmin(request, env))) return resJson({ ok:false, error:"Unauthorized" }, 401);

        // Liste: /admin/raffles
        if (m === "GET" && p === "/admin/raffles") {
          const rids = await listRids(env);
          const out = [];
          for (const rid of rids) {
            const s = await getSettings(env, rid);
            const totals = await countTotals(env, rid);
            out.push({ rid, title:s?.title||"", startAt:s?.startAt||null, endAt:s?.endAt||null, closed:!!s?.closed, totals });
          }
          return resJson({ ok:true, raffles: out.sort((a,b)=> (b.startAt||0)-(a.startAt||0)) });
        }

        // Ayar getir: /admin/settings?rid=
        if (m === "GET" && p === "/admin/settings") {
          const rid = ridParam(url); if (!rid) return resJson({ ok:false, error:"rid gerekli" }, 400);
          const s = await getSettings(env, rid);
          if (!s) return resJson({ ok:false, error:"not found" }, 404);
          return resJson({ ok:true, settings: s });
        }

        // Ayar kaydet/oluştur: /admin/settings?rid=
        if (m === "POST" && p === "/admin/settings") {
          const rid = ridParam(url); if (!rid) return resJson({ ok:false, error:"rid gerekli" }, 400);
          const body = await safeJson(request);
          const cur = (await getSettings(env, rid)) || {};
          const next = {
            rid,
            title: body.title || cur.title || "Çekiliş",
            mailFrom: body.mailFrom || cur.mailFrom || "Velour <onboarding@resend.dev>",
            startAt: nOrNull(body.startAt, cur.startAt),
            endAt:   nOrNull(body.endAt, cur.endAt),
            closed:  typeof body.closed === "boolean" ? body.closed : !!cur.closed,
            youtubeHandle: body.youtubeHandle || cur.youtubeHandle || "@mwharp",
            youtubeLink:   body.youtubeLink   || cur.youtubeLink   || "https://www.youtube.com/@mwharp",
            createdAt: cur.createdAt || Date.now()
          };
          await env.RAFFLE.put(keySettings(rid), JSON.stringify(next));
          return resJson({ ok:true, settings: next });
        }

        // Kapat: /admin/close?rid=
        if (m === "POST" && p === "/admin/close") {
          const rid = ridParam(url); if (!rid) return resJson({ ok:false, error:"rid gerekli" }, 400);
          const s = await getSettings(env, rid);
          if (!s) return resJson({ ok:false, error:"yok" }, 404);
          s.closed = true;
          await env.RAFFLE.put(keySettings(rid), JSON.stringify(s));
          return resJson({ ok:true, settings: s });
        }

        // Export: /admin/export?rid=
        if (m === "GET" && p === "/admin/export") {
          const rid = ridParam(url); if (!rid) return resJson({ ok:false, error:"rid gerekli" }, 400);
          const rows = await exportRows(env, rid);
          return resJson({ ok:true, rows });
        }

        // Bitiş maili: /admin/notify-end?rid=
        if (m === "POST" && p === "/admin/notify-end") {
          const rid = ridParam(url); if (!rid) return resJson({ ok:false, error:"rid gerekli" }, 400);
          const s = await getSettings(env, rid);
          if (!s?.endAt) return resJson({ ok:false, error:"Önce bitiş zamanı ayarla." }, 400);
          const keys = await listCodes(env, rid);
          let sent=0, skipped=0, errors=0;
          for (const k of keys) {
            const rec = await env.RAFFLE.get(k, { type:"json" }); if (!rec) continue;
            if (rec.notifiedEnd) { skipped++; continue; }
            try {
              await sendMail(env, { to: rec.email, subject: `${s.title || "Çekiliş"} sona erdi`, text: endMailText(s, rec), from: s.mailFrom || "Velour <onboarding@resend.dev>" });
              rec.notifiedEnd = true;
              await env.RAFFLE.put(k, JSON.stringify(rec));
              sent++;
            } catch { errors++; }
          }
          return resJson({ ok:true, result:{ sent, skipped, errors } });
        }

        // Çekiliş sil: /admin/raffle?rid=  (tüm anahtarları temizler)
        if (m === "DELETE" && p === "/admin/raffle") {
          const rid = ridParam(url); if (!rid) return resJson({ ok:false, error:"rid gerekli" }, 400);
          const keys = await listAllForRid(env, rid);
          for (const k of keys) await env.RAFFLE.delete(k);
          return resJson({ ok:true, deleted: keys.length });
        }

        // Tek kayıt sil: /admin/entry?rid=&code=
        if (m === "DELETE" && p === "/admin/entry") {
          const rid = ridParam(url); const code = str(url.searchParams.get("code"));
          if (!rid || !code) return resJson({ ok:false, error:"rid/kod gerekli" }, 400);
          const h = await sha256hex(code);
          const rec = await env.RAFFLE.get(keyCode(rid,h), { type:"json" });
          if (!rec) return resJson({ ok:false, error:"bulunamadı" }, 404);
          await env.RAFFLE.delete(keyCode(rid,h));
          await env.RAFFLE.delete(keyEmail(rid, rec.email));
          return resJson({ ok:true, deleted:true });
        }
      }

      return resJson({ ok:false, error:"Not found" }, 404);

    } catch (e) {
      return resJson({ ok:false, error:String(e?.message||e) }, 500);
    }
  }
};

/* ===== Helpers ===== */
function resCors(body, status=200, headers={}) {
  return new Response(body, { status, headers: { "Access-Control-Allow-Origin":"*", "Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS", "Access-Control-Allow-Headers":"Content-Type, Authorization", ...headers }});
}
function resJson(obj, status=200) {
  return resCors(JSON.stringify(obj), status, { "Content-Type":"application/json" });
}
function str(v){ return (v||"").toString().trim(); }
function nOrNull(v,d){ if (v===null||v===undefined||v==="") return d??null; const n=Number(v); return Number.isFinite(n)?n:(d??null); }
function ridParam(url){ return str(url.searchParams.get("rid")).toLowerCase(); }
function keySettings(rid){ return `settings:${rid}`; }
function keyEmail(rid,email){ return `email:${rid}:${email}`; }
function keyCode(rid,hash){ return `code:${rid}:${hash}`; }

function settingsPublic(s){
  return { title:s.title, startAt:s.startAt||null, endAt:s.endAt||null, closed:!!s.closed, youtubeHandle:s.youtubeHandle||"@mwharp", youtubeLink:s.youtubeLink||"https://www.youtube.com/" };
}

async function getSettings(env, rid){
  if (!rid) return null;
  return await env.RAFFLE.get(keySettings(rid), { type:"json" });
}

async function listRids(env){
  const out=[]; let cursor=undefined;
  do{
    const l = await env.RAFFLE.list({ prefix:"settings:", cursor });
    for (const k of l.keys) out.push(k.name.split(":")[1]);
    cursor = l.list_complete ? undefined : l.cursor;
  }while(cursor);
  return out;
}
async function listCodes(env, rid){
  const out=[]; let cursor=undefined; const prefix = `code:${rid}:`;
  do{
    const l = await env.RAFFLE.list({ prefix, cursor });
    for (const k of l.keys) out.push(k.name);
    cursor = l.list_complete ? undefined : l.cursor;
  }while(cursor);
  return out;
}
async function listAllForRid(env, rid){
  const out=[]; let cursor=undefined;
  for (const pref of [`settings:${rid}`, `email:${rid}:`, `code:${rid}:`]){
    cursor=undefined;
    do{
      const l = await env.RAFFLE.list({ prefix: pref, cursor });
      for (const k of l.keys) out.push(k.name);
      cursor = l.list_complete ? undefined : l.cursor;
    }while(cursor);
  }
  return out;
}
async function countTotals(env, rid){
  const keys = await listCodes(env, rid);
  let entries=0, winners=0;
  for (const k of keys){ const rec = await env.RAFFLE.get(k, { type:"json" }); if(rec){ entries++; if(rec.winner) winners++; } }
  return { entries, winners };
}

async function handleSubmit(request, env){
  const url = new URL(request.url);
  const rid = ridParam(url);
  if (!rid) return resJson({ ok:false, error:"rid gerekli" }, 400);

  const form = await request.formData();
  const gameName = str(form.get("gameName"));
  const gameId   = str(form.get("gameId"));
  const discord  = str(form.get("discord"));
  const subscriber = str(form.get("subscriber"));
  const email    = str(form.get("email")).toLowerCase();

  if (!gameName || !gameId || !discord || !subscriber || !email) {
    return resJson({ ok:false, error:"Zorunlu alanlar eksik." }, 400);
  }

  const s = await getSettings(env, rid);
  if (!s) return resJson({ ok:false, error:"Bu rid için çekiliş yok." }, 404);

  const now = Date.now();
  if (s.startAt && now < s.startAt) return resJson({ ok:false, error:"Çekiliş henüz başlamadı." }, 403);
  if (s.closed || (s.endAt && now >= s.endAt)) return resJson({ ok:false, error:"Çekiliş kapalı." }, 403);

  // unique email per rid
  const existing = await env.RAFFLE.get(keyEmail(rid, email));
  if (existing) return resJson({ ok:false, error:"Bu e-posta ile zaten kayıt var." }, 409);

  // dosyalar → GitHub
  const files = form.getAll("attachments");
  const MAX_FILES=6, MAX_FILE_SIZE=8*1024*1024, MAX_TOTAL_SIZE=9*1024*1024;
  let total=0; const links=[];
  for (const f of files.slice(0,MAX_FILES)){
    if (typeof f==="string") continue;
    const size=f.size||0;
    if (size > MAX_FILE_SIZE) return resJson({ ok:false, error:`Dosya çok büyük: ${f.name}` }, 413);
    if (total + size > MAX_TOTAL_SIZE) return resJson({ ok:false, error:"Toplam dosya boyutu sınırı aşıldı." }, 413);
    total += size;
    const ab = await f.arrayBuffer();
    const up = await uploadToGitHub({ name:f.name, base64: bufToB64(ab) }, env);
    links.push(up.raw_url);
  }

  const code = makeCode();
  const h = await sha256hex(code);

  const rec = { rid, email, gameName, gameId, discord, subscriber, attachments:links, createdAt:Date.now(), winner:false, notifiedEnd:false };
  await env.RAFFLE.put(keyCode(rid,h), JSON.stringify(rec));
  await env.RAFFLE.put(keyEmail(rid,email), h);

  if (!env.SHEET_WEBHOOK) return resJson({ ok:false, error:"SHEET_WEBHOOK tanımlı değil." }, 500);
  await fetch(env.SHEET_WEBHOOK, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ rid, gameName, gameId, discord, subscriber, email, code, attachments:links }) });

  await sendMail(env, { to: email, subject: `${s.title||"Çekiliş"} kayıt kodun`, text: joinMailText(s, { gameName, code }), from: s.mailFrom || "Velour <onboarding@resend.dev>" });

  return resJson({ ok:true, codeSent:true });
}

/* crypto / misc */
async function sha256hex(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
function makeCode(){
  const c="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; const pick=n=>Array.from({length:n},()=>c[Math.floor(Math.random()*c.length)]).join("");
  return `${pick(4)}-${pick(4)}`;
}
function bufToB64(buffer){ let bin=""; const bytes=new Uint8Array(buffer); for(let i=0;i<bytes.byteLength;i++) bin+=String.fromCharCode(bytes[i]); return btoa(bin); }

async function uploadToGitHub({ name, base64 }, env){
  if (!env.GH_TOKEN || !env.GH_REPO) throw new Error("GH_TOKEN/GH_REPO eksik");
  const repo=env.GH_REPO, branch=env.GH_BRANCH||"main", root=(env.GH_DIR||"uploads").replace(/^\/|\/$/g,"");
  const d=new Date(); const yyyy=d.getUTCFullYear(), mm=String(d.getUTCMonth()+1).padStart(2,"0"), dd=String(d.getUTCDate()).padStart(2,"0");
  const stamp=`${yyyy}${mm}${dd}`;
  const safe=(name||"file").replace(/[^a-zA-Z0-9._-]/g,"_");
  const rand=Math.random().toString(36).slice(2,10);
  const path=`${root}/${stamp}/${rand}_${safe}`;
  const url=`https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}`;
  const r = await fetch(url, { method:"PUT", headers:{ "Authorization":`Bearer ${env.GH_TOKEN}`, "Content-Type":"application/json", "Accept":"application/vnd.github+json", "User-Agent":"cf-worker-uploader" }, body: JSON.stringify({ message:`Upload ${safe}`, content:base64, branch }) });
  const t = await r.text(); let j={}; try{ j=JSON.parse(t);}catch{ j={ raw:t }; }
  if(!r.ok) throw new Error(`GitHub ${r.status}: ${j?.message||j?.raw||"unknown"}`);
  const raw=`https://raw.githubusercontent.com/${repo}/${branch}/${path}`;
  return { raw_url: raw };
}

async function sendMail(env, { to, subject, text, from }){
  const r = await fetch("https://api.resend.com/emails", { method:"POST", headers:{ "Authorization":`Bearer ${env.RESEND_API_KEY}`, "Content-Type":"application/json" }, body: JSON.stringify({ from, to:[to], subject, text }) });
  if(!r.ok){ const t=await r.text(); throw new Error(`Resend ${r.status}: ${t}`); }
}
function joinMailText(s, { gameName, code }){
  const title=s.title||"Çekiliş";
  const end = s.endAt ? new Date(s.endAt).toLocaleString("tr-TR") : "yakında";
  return `Merhaba ${gameName},

${title} kaydın alındı. Benzersiz kodun:

    ${code}

Sonucu bu kodla şu sayfadan öğrenebilirsin:
https://<senin-domainin>/sonuc

Bitiş: ${end}

Bol şans!
– HARP Ekibi`;
}
function endMailText(s, rec){
  const title=s.title||"Çekiliş";
  return `Merhaba,

${title} sona erdi. Katıldığın için teşekkürler.

Kazandı mı?: ${rec.winner ? "EVET! 🎉" : "Bu kez olmadı."}

Detay: https://<senin-domainin>/sonuc

– HARP Ekibi`;
}

async function authAdmin(request, env){
  const token = request.headers.get("Authorization")||"";
  const got = token.startsWith("Bearer ")? token.slice(7): null;
  return !!got && !!env.ADMIN_TOKEN && tEqual(got, env.ADMIN_TOKEN);
}
function tEqual(a,b){ if(!a||!b||a.length!==b.length) return false; let out=0; for(let i=0;i<a.length;i++) out|=a.charCodeAt(i)^b.charCodeAt(i); return out===0; }

async function safeJson(request){ try{ return await request.json(); }catch{ return {}; } }

async function exportRows(env, rid){
  const keys = await listCodes(env, rid); const rows=[];
  for (const k of keys){ const r = await env.RAFFLE.get(k, { type:"json" }); if(!r) continue;
    rows.push({ email:r.email, gameName:r.gameName, gameId:r.gameId, discord:r.discord, subscriber:r.subscriber, createdAt:r.createdAt, winner:!!r.winner });
  }
  return rows;
}
