<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Canlı Çekiliş Durumu</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{ --bg:#0b1020; --glass:#0f1733cc; --text:#ecf1ff; --muted:#a9b4d6; --primary:#5ea1ff; --border:1px solid rgba(255,255,255,.12); --radius:16px; --shadow:0 16px 40px rgba(0,0,0,.35), 0 4px 14px rgba(0,0,0,.25); }
  @media (prefers-color-scheme: light){ :root{ --text:#0b1020; --muted:#4b5563; --glass:#ffffffd9; --bg:#eef3ff; --border:1px solid rgba(0,0,0,.08); --shadow:0 18px 36px rgba(2,6,23,.08), 0 2px 10px rgba(2,6,23,.06);} }
  *{box-sizing:border-box} body{margin:0; color:var(--text); font:16px/1.5 ui-sans-serif,system-ui; background:#000 url('https://images.wallpapersden.com/image/download/world-of-warships-gaming-2023_bW5namiUmZqaraWkpJRmbmdlrWZlbWU.jpg') center/cover fixed no-repeat;}
  .overlay{position:fixed; inset:0; background: radial-gradient(1000px 600px at 20% 10%, rgba(0,0,0,.45), transparent 60%), linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55)); pointer-events:none;}
  .wrap{max-width:800px; margin:min(6vh,64px) auto; padding:20px}
  .card{background:var(--glass); border:var(--border); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px) saturate(120%); overflow:hidden}
  header{padding:16px 18px; border-bottom:var(--border); display:flex; align-items:center; justify-content:space-between}
  h1{margin:0; font-size:clamp(22px,3vw,28px)}
  main{padding:18px; display:grid; gap:14px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .tag{border:var(--border); border-radius:999px; padding:6px 10px; background:color-mix(in oklab, var(--glass) 96%, transparent); color:var(--muted)}
  ul{list-style:none; margin:0; padding:0; display:grid; gap:8px}
  li{border:var(--border); border-radius:12px; padding:10px; background:color-mix(in oklab, var(--glass) 96%, transparent)}
</style>
</head>
<body>
<div class="overlay" aria-hidden="true"></div>
<div class="wrap">
  <div class="card">
    <header><h1 id="title">Çekiliş</h1><span class="tag" id="state">Yükleniyor…</span></header>
    <main>
      <div class="row">
        <span class="tag">RID: <b id="ridSpan">-</b></span>
        <span class="tag">Toplam Katılım: <b id="count">0</b></span>
        <span class="tag">Bitişe: <b id="cd">—</b></span>
      </div>
      <div>
        <h3 style="margin:6px 0">Son Kayıtlar</h3>
        <ul id="list"><li class="tag">Henüz yok.</li></ul>
      </div>
    </main>
  </div>
</div>
<script>
const BASE = "https://spring-dream-b90b.velour662.workers.dev";
const p = new URL(location.href).searchParams;
const rid = (p.get("rid")||"default");
document.getElementById("ridSpan").textContent = rid;

async function pull(){
  try{
    const r = await fetch(`${BASE}/public/stats?rid=${encodeURIComponent(rid)}`);
    const j = await r.json();
    if(!j.ok) return;
    document.getElementById("title").textContent = j.title || "Çekiliş";
    document.getElementById("count").textContent = j.count || 0;
    const now = Date.now();
    let txt="—"; if (j.startAt && now < j.startAt) txt = "başlamasına " + fmt(j.startAt - now);
    else if (j.endAt && now < j.endAt) txt = "bitmesine " + fmt(j.endAt - now);
    else if (j.state==="closed") txt="bitti";
    document.getElementById("cd").textContent = txt;
    document.getElementById("state").textContent = j.state==="open" ? "Açık" : (j.state==="before" ? "Henüz başlamadı" : "Kapandı");
  }catch{}
}
function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=(s%60); return `${h} sa ${m} dk ${ss} sn`; }
setInterval(pull, 5000); pull();

// son kayıtları “hafızasız” basitçe: sayfa açıkken ekle
const list=document.getElementById("list");
const es = new EventSource(`${BASE}/public/stream?rid=${encodeURIComponent(rid)}`);
es.addEventListener("message", ev=>{
  try{
    const d=JSON.parse(ev.data);
    if(d.type==="entry"){
      if(list.firstElementChild && list.firstElementChild.classList.contains("tag")) list.innerHTML="";
      const li=document.createElement("li");
      li.textContent = `${d.gameName} • ${mask(d.email)} • ${new Date(d.createdAt).toLocaleString("tr-TR")}`;
      list.prepend(li);
      const c=parseInt(document.getElementById("count").textContent||"0",10)+1; document.getElementById("count").textContent=c;
    }
  }catch{}
});
function mask(e){ const [u,d]=(e||"").split("@"); if(!d) return e; return (u.slice(0,2)+"***")+"@"+d; }
</script>
</body>
</html>
