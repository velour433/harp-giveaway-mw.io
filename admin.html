<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin • Çekilişler</title>
<meta name="color-scheme" content="dark light">
<style>
:root{ --bg:#0b1020; --glass:#0f1733cc; --text:#ecf1ff; --muted:#a9b4d6; --primary:#5ea1ff; --accent:#34d399; --danger:#ff6b6b; --border:1px solid rgba(255,255,255,.12); --radius:16px; --shadow:0 16px 40px rgba(0,0,0,.35), 0 4px 14px rgba(0,0,0,.25); }
@media (prefers-color-scheme: light){ :root{ --text:#0b1020; --muted:#4b5563; --glass:#ffffffd9; --bg:#eef3ff; --border:1px solid rgba(0,0,0,.08); --shadow:0 18px 36px rgba(2,6,23,.08), 0 2px 10px rgba(2,6,23,.06);} }
*{box-sizing:border-box} html,body{height:100%}
body{ margin:0; color:var(--text); font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#000 url('https://images.wallpapersden.com/image/download/world-of-warships-gaming-2023_bW5namiUmZqaraWkpJRmbmdlrWZlbWU.jpg') center/cover fixed no-repeat; }
.overlay{position:fixed; inset:0; background: radial-gradient(1000px 600px at 20% 10%, rgba(0,0,0,.45), transparent 60%), linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55)); pointer-events:none;}
.wrap{max-width:1100px; margin:min(6vh,64px) auto; padding:20px}
.section{background:var(--glass); border:var(--border); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px) saturate(120%); overflow:hidden; margin-bottom:16px}
.head{display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:var(--border)}
h2{margin:0; font-size:clamp(18px,2.2vw,22px)}
.content{padding:16px; display:grid; gap:12px}
.row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
.field{display:flex; flex-direction:column; gap:6px}
input,select,textarea{ padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:color-mix(in oklab, var(--glass) 92%, transparent); color:var(--text); min-width:200px }
.btn{border:var(--border); background:linear-gradient(180deg, color-mix(in oklab, var(--primary) 18%, var(--glass)) 0%, var(--glass) 80%); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow:var(--shadow); min-height:40px}
.btn.ghost{background:transparent}
.tag{border:var(--border); border-radius:999px; padding:6px 10px; background:color-mix(in oklab, var(--glass) 96%, transparent); color:var(--muted)}
table{width:100%; border-collapse:separate; border-spacing:0 8px}
th,td{padding:10px 12px; text-align:left}
tbody tr{background:color-mix(in oklab, var(--glass) 96%, transparent); border:var(--border)}
tbody tr td{border-top:var(--border); border-bottom:var(--border)}
tbody tr td:first-child{border-left:var(--border); border-top-left-radius:10px; border-bottom-left-radius:10px}
tbody tr td:last-child{border-right:var(--border); border-top-right-radius:10px; border-bottom-right-radius:10px}
.toast{position:fixed; right:16px; bottom:16px; background:var(--glass); border:var(--border); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); opacity:0; transform:translateY(10px); transition:.2s}
.toast.show{opacity:1; transform:none}
.lock{position:fixed; inset:0; display:grid; place-items:center; z-index:10}
.panel{max-width:520px; width:92%; background:var(--glass); border:var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow); backdrop-filter:blur(10px) saturate(120%)}
.app-blur{filter:blur(6px);} [hidden]{display:none !important;}
</style>
</head>
<body>
<div class="overlay" aria-hidden="true"></div>

<!-- KİLİT -->
<div id="lock" class="lock">
  <div class="panel">
    <h2 style="margin:0 0 10px">Admin Girişi</h2>
    <div class="field"><label>Worker URL</label><input id="base" type="text" placeholder="https://spring-dream-....workers.dev"></div>
    <div class="field"><label>Bearer Token</label><input id="token" type="text" placeholder="ADMIN_TOKEN"></div>
    <div class="row"><button class="btn" id="enter">Giriş Yap</button></div>
    <p class="tag">Bilgiler localStorage’da saklanır.</p>
  </div>
</div>

<!-- APP -->
<div class="wrap app-blur" id="app" hidden>
  <section class="section">
    <div class="head"><h2>Yeni Çekiliş Oluştur</h2></div>
    <div class="content">
      <div class="row">
        <div class="field"><label>RID</label><input id="newRid" type="text" placeholder="r-250830-AB7Q"></div>
        <div class="field"><label>Başlık</label><input id="newTitle" type="text" placeholder="Örn: Modern Warfare Ağustos"></div>
        <div class="field"><label>YouTube Handle</label><input id="newYtHandle" type="text" placeholder="@mwharp"></div>
        <div class="field"><label>YouTube Link</label><input id="newYtLink" type="text" placeholder="https://www.youtube.com/@mwharp"></div>
      </div>
      <div class="row"><button class="btn" id="create">Oluştur</button><button class="btn ghost" id="genRid">RID üret</button></div>
      <p class="tag">“Oluştur”, girilen RID altında ayar kaydeder (yoksa oluşturur).</p>
    </div>
  </section>

  <section class="section">
    <div class="head"><h2>Tüm Çekilişler</h2><button class="btn ghost" id="refreshList">Yenile</button></div>
    <div class="content" style="overflow:auto">
      <table>
        <thead><tr><th>RID</th><th>Başlık</th><th>Başlangıç</th><th>Bitiş</th><th>Durum</th><th>Kat./Kaz.</th><th>Aksiyon</th></tr></thead>
      <tbody id="raffleRows"><tr><td class="tag">Yükleniyor…</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="section" id="manageSec" hidden>
    <div class="head"><h2>Yönet: <span id="curRidTag" class="tag"></span></h2></div>
    <div class="content">
      <div class="row">
        <div class="field"><label>Başlık</label><input id="title" type="text"></div>
        <div class="field"><label>Başlangıç</label><input id="start" type="datetime-local"></div>
        <div class="field"><label>Bitiş</label><input id="end" type="datetime-local"></div>
        <div class="field"><label>Gönderen (e-posta)</label><input id="from" type="text" placeholder="Velour &lt;onboarding@resend.dev&gt;"></div>
      </div>
      <div class="row">
        <div class="field"><label>YouTube Handle</label><input id="ytHandle" type="text" placeholder="@mwharp"></div>
        <div class="field"><label>YouTube Link</label><input id="ytLink" type="text" placeholder="https://www.youtube.com/@mwharp"></div>
      </div>
      <div class="row"><button class="btn" id="save">Kaydet</button><button class="btn" id="closeNow">Şimdi Kapat</button><button class="btn" id="notifyEnd">Bitiş Maili Gönder</button></div>
      <div class="row"><button class="btn ghost" id="exportBtn">Dışa Aktar (JSON)</button><button class="btn ghost" id="delRaffle">Bu Çekilişi Sil</button></div>
      <hr style="opacity:.2">
      <div class="row"><input id="codeDel" type="text" placeholder="Kod"><button class="btn" id="delEntry">Bu Kaydı Sil</button></div>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
(function(){
  var ls=localStorage, $=function(s){return document.querySelector(s);};
  function toast(x){var t=$("#toast");t.textContent=typeof x==="string"?x:JSON.stringify(x);t.classList.add("show");clearTimeout(t._t);t._t=setTimeout(function(){t.classList.remove("show");},2600);}
  function sanitizeBase(v){v=(v||"").trim(); if(v&&!/^https?:\/\//i.test(v)) v="https://"+v; return v.replace(/\/+$/,"");}
  function hdrs(){var t=ls.getItem("adm.token")||""; return t?{"Authorization":"Bearer "+t}:{ }; }
  function base(){return sanitizeBase(ls.getItem("adm.base")||"");}
  function genRid(){var d=new Date();var y=(""+d.getFullYear()).slice(2);var m=("0"+(d.getMonth()+1)).slice(-2);var day=("0"+d.getDate()).slice(-2);var pool="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";var r="";for(var i=0;i<4;i++) r+=pool[Math.floor(Math.random()*pool.length)];return "r-"+y+m+day+"-"+r;}

  $("#enter").onclick=function(){
    var b=sanitizeBase($("#base").value), t=($("#token").value||"").trim();
    if(!b||!t){ toast("URL ve token gerekli"); return; }
    ls.setItem("adm.base",b); ls.setItem("adm.token",t);
    fetch(b+"/",{mode:"cors"}).then(function(r){
      if(!r.ok){ toast("Ping HTTP "+r.status); return; }
      $("#lock").hidden=true; $("#app").hidden=false; $(".wrap").classList.remove("app-blur");
      $("#newRid").value=genRid(); loadList(); autoRefresh();
    }).catch(function(e){ toast("Hata: "+(e.message||e)); });
  };
  $("#genRid").onclick=function(){ $("#newRid").value=genRid(); };

  function loadList(){
    fetch(base()+"/admin/raffles",{headers:hdrs(),mode:"cors"}).then(function(r){ if(!r.ok){toast("Liste HTTP "+r.status); return;} return r.json();}).then(function(j){
      if(!j) return; var tb=$("#raffleRows"); tb.innerHTML=""; var list=j.raffles||[]; if(!list.length){tb.innerHTML='<tr><td class="tag" colspan="7">Henüz çekiliş yok.</td></tr>'; return;}
      list.forEach(function(x){
        var tr=document.createElement("tr");
        tr.innerHTML='<td><code>'+x.rid+'</code></td>'+
          '<td>'+(x.title||"—")+'</td>'+
          '<td>'+(x.startAt?new Date(x.startAt).toLocaleString("tr-TR"):"—")+'</td>'+
          '<td>'+(x.endAt?new Date(x.endAt).toLocaleString("tr-TR"):"—")+'</td>'+
          '<td>'+(x.closed?"Kapalı":"Açık")+'</td>'+
          '<td>'+((x.totals&&x.totals.entries)||0)+' / '+((x.totals&&x.totals.winners)||0)+'</td>'+
          '<td><button class="btn" data-act="manage" data-rid="'+x.rid+'">Yönet</button> '+
          '<button class="btn ghost" data-act="delete" data-rid="'+x.rid+'">Sil</button> '+
          '<a class="btn ghost" href="./index.html?rid='+encodeURIComponent(x.rid)+'" target="_blank" rel="noopener">Aç</a></td>';
        tb.appendChild(tr);
      });
      tb.querySelectorAll("button[data-act]").forEach(function(b){
        b.onclick=function(e){ var rid=e.currentTarget.getAttribute("data-rid"); var act=e.currentTarget.getAttribute("data-act"); if(act==="manage") selectRid(rid); if(act==="delete" && confirm(rid+" silinsin mi?")) delRaffle(rid); };
      });
    }).catch(function(e){ toast("Liste hata: "+(e.message||e)); });
  }
  $("#refreshList").onclick=loadList;

  function delRaffle(rid){
    fetch(base()+"/admin/raffle?rid="+encodeURIComponent(rid),{method:"DELETE",headers:hdrs(),mode:"cors"}).then(function(r){ if(!r.ok){toast("Sil HTTP "+r.status); return;} toast("Silindi"); if(ls.getItem("adm.rid")===rid){ ls.removeItem("adm.rid"); $("#manageSec").hidden=true; } loadList(); }).catch(function(e){ toast("Sil hata: "+(e.message||e)); });
  }

  $("#create").onclick=function(){
    var rid=($("#newRid").value||"").trim().toLowerCase(); if(!rid){ toast("RID gerekli"); return; }
    var body={ title:($("#newTitle").value||"").trim()||"Çekiliş", youtubeHandle:($("#newYtHandle").value||"").trim()||"@mwharp", youtubeLink:($("#newYtLink").value||"").trim()||"https://www.youtube.com/@mwharp" };
    fetch(base()+"/admin/settings?rid="+encodeURIComponent(rid),{ method:"POST", headers:Object.assign({},hdrs(),{"Content-Type":"application/json"}), body:JSON.stringify(body), mode:"cors"}).then(function(r){ if(!r.ok){ toast("Oluştur HTTP "+r.status); return;} toast("Oluşturuldu"); $("#newRid").value=genRid(); loadList(); }).catch(function(e){ toast("Oluştur hata: "+(e.message||e)); });
  };

  function selectRid(rid){
    ls.setItem("adm.rid",rid); $("#curRidTag").textContent=rid; $("#manageSec").hidden=false;
    fetch(base()+"/admin/settings?rid="+encodeURIComponent(rid),{headers:hdrs(),mode:"cors"}).then(function(r){ if(!r.ok){toast("Ayar HTTP "+r.status); return;} return r.json();}).then(function(j){
      if(!j) return; var s=j.settings||{};
      $("#title").value=s.title||""; $("#from").value=s.mailFrom||""; $("#ytHandle").value=s.youtubeHandle||""; $("#ytLink").value=s.youtubeLink||"";
      $("#start").value=s.startAt? toLocalInput(s.startAt):""; $("#end").value=s.endAt? toLocalInput(s.endAt):"";
    }).catch(function(e){ toast("Ayar hata: "+(e.message||e)); });
  }

  $("#save").onclick=function(){
    var rid=ls.getItem("adm.rid"); if(!rid){ toast("Önce çekiliş seç."); return; }
    var body={ title:($("#title").value||"").trim(), mailFrom:($("#from").value||"").trim(), youtubeHandle:($("#ytHandle").value||"").trim(), youtubeLink:($("#ytLink").value||"").trim(), startAt:fromLocalInput($("#start").value), endAt:fromLocalInput($("#end").value) };
    fetch(base()+"/admin/settings?rid="+encodeURIComponent(rid),{ method:"POST", headers:Object.assign({},hdrs(),{"Content-Type":"application/json"}), body:JSON.stringify(body), mode:"cors"}).then(function(r){ if(!r.ok){ toast("Kaydet HTTP "+r.status); return;} toast("Kaydedildi"); loadList(); }).catch(function(e){ toast("Kaydet hata: "+(e.message||e)); });
  };

  $("#closeNow").onclick=function(){
    var rid=ls.getItem("adm.rid"); if(!rid){ toast("Önce çekiliş seç."); return; }
    fetch(base()+"/admin/close?rid="+encodeURIComponent(rid),{method:"POST",headers:hdrs(),mode:"cors"}).then(function(r){ if(!r.ok){ toast("Kapat HTTP "+r.status); return;} toast("Kapandı"); loadList(); selectRid(rid); }).catch(function(e){ toast("Kapat hata: "+(e.message||e)); });
  };

  $("#notifyEnd").onclick=function(){
    var rid=ls.getItem("adm.rid"); if(!rid){ toast("Önce çekiliş seç."); return; }
    fetch(base()+"/admin/notify-end?rid="+encodeURIComponent(rid),{method:"POST",headers:hdrs(),mode:"cors"}).then(function(r){ return r.json().then(function(j){ return { ok:r.ok, status:r.status, j:j }; }); }).then(function(res){ if(!res.ok){ toast("Mail HTTP "+res.status); return;} var sent=(res.j&&res.j.result&&res.j.result.sent)||0; var skipped=(res.j&&res.j.result&&res.j.result.skipped)||0; toast("Mail: "+sent+" gönderildi, "+skipped+" atlandı"); }).catch(function(e){ toast("Mail hata: "+(e.message||e)); });
  };

  $("#exportBtn").onclick=function(){
    var rid=ls.getItem("adm.rid"); if(!rid){ toast("Önce çekiliş seç."); return; }
    fetch(base()+"/admin/export?rid="+encodeURIComponent(rid),{headers:hdrs(),mode:"cors"}).then(function(r){ if(!r.ok){ toast("Export HTTP "+r.status); return;} return r.json();}).then(function(j){ if(!j) return; var blob=new Blob([JSON.stringify(j,null,2)],{type:"application/json"}); var a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="export_"+rid+".json"; a.click(); URL.revokeObjectURL(a.href); }).catch(function(e){ toast("Export hata: "+(e.message||e)); });
  };

  $("#delRaffle").onclick=function(){
    var rid=ls.getItem("adm.rid"); if(!rid){ toast("Önce çekiliş seç."); return; }
    if (!confirm(rid+" silinsin mi? Bu işlem geri alınamaz.")) return;
    delRaffle(rid);
  };

  $("#delEntry").onclick=function(){
    var rid=ls.getItem("adm.rid"); var code=($("#codeDel").value||"").trim(); if(!rid||!code){ toast("RID ve Kod gerekli"); return; }
    fetch(base()+"/admin/entry?rid="+encodeURIComponent(rid)+"&code="+encodeURIComponent(code),{method:"DELETE",headers:hdrs(),mode:"cors"}).then(function(r){ if(!r.ok){ toast("Kayıt sil HTTP "+r.status); return;} toast("Kayıt silindi"); }).catch(function(e){ toast("Kayıt sil hata: "+(e.message||e)); });
  };

  var _int=null; function autoRefresh(){ if(_int) clearInterval(_int); _int=setInterval(loadList,10000); }
  function toLocalInput(ms){ var d=new Date(ms); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,16); }
  function fromLocalInput(v){ if(!v) return null; var d=new Date(v); return d.getTime(); }
})();
</script>
</body>
</html>
